---
title: "OB DATA Analytics"
author: 'Oguchi Nkwocha, MD., MS'
format: html
server: shiny
---

```{r setup, include=FALSE}
library(shiny)
library(dplyr)
library(DT)
library(ggplot2)
library(broom)

# Load your dataset and prepare the data
ob_data_clst_xi <- readRDS("Complete Ready OB Dataset for Analytics.RDS") %>%
  dplyr::select(zip, age, grav, para, diff_grav_para, lbr_type_cnsldt, membrane_rupture, intrapartal_conditions, 
                presentation_cnsldt, conditions_cnsldt, uds_age, adm_to_del_tm_cat, hghRsk, cluster) %>%
  mutate(cluster = if_else(cluster == 2, 1, 0))

```

```{r}
#| context: server

output$selectInputUI <- renderUI({
  valid_factors <- names(ob_data_clst_xi)[sapply(ob_data_clst_xi, function(x) is.factor(x) && length(unique(x)) > 1)]
  selectInput("selectedFactor", "Select Factor Variable:", choices = valid_factors)
})

output$factorTable <- DT::renderDT({
  req(input$selectedFactor)
  
  local_data <- ob_data_clst_xi %>%
    mutate(across(where(is.factor), ~ as.numeric(as.factor(.))))
  
  get_numeric_mapping <- function(df, column) {
    factor_column <- as.factor(df[[column]])
    if (length(levels(factor_column)) <= 1) return(NULL)  # Skip if only one level
    mapping <- data.frame(Original = levels(factor_column), Numeric = as.numeric(factor_column), Variable = column)
    return(mapping)
  }
  
  mappings <- lapply(names(local_data)[sapply(local_data, is.factor)], function(col) get_numeric_mapping(local_data, col))
  mappings <- Filter(Negate(is.null), mappings)
  combined_mapping_df <- do.call(rbind, mappings)
  
  if (is.null(combined_mapping_df) || nrow(combined_mapping_df) == 0) {
    DT::datatable(data.frame(Original = "No data", Numeric = NA, Variable = "No variable"))
  } else {
    var <- input$selectedFactor
    selected_mapping <- dplyr::filter(combined_mapping_df, Variable == var)
    DT::datatable(selected_mapping, options = list(pageLength = 5, scrollX = TRUE))
  }
})

output$coefPlot <- renderPlot({
  req(input$selectedFactor)

  formula <- as.formula(paste("cluster ~", input$selectedFactor))
  model <- glm(formula, data = ob_data_clst_xi, family = binomial())

  model_tidy <- broom::tidy(model) %>%
    mutate(estimate = round(estimate, 3),
           p.value = round(p.value, 3),
           sig = p.value < 0.05)

  ggplot(model_tidy, aes(x = reorder(term, estimate), y = estimate, color = sig)) +
    geom_point() +
    geom_text(aes(label = paste("Coeff:", estimate, "\nP-val:", p.value), y = estimate + 0.05), check_overlap = TRUE, hjust = 0.5) +
    geom_errorbar(aes(ymin = estimate - std.error, ymax = estimate + std.error), width = 0.2) +
    coord_flip() +
    scale_color_manual(values = c("black", "red"), labels = c("Not Significant", "Significant")) +
    labs(title = "Logistic Regression Coefficients", x = "Predictor Variables", y = "Coefficient Estimate", color = "P-value Significance")
})

```

```{r}
fluidPage(
  titlePanel("OB DATA Analytics"),
  sidebarLayout(
    sidebarPanel(
      uiOutput("selectInputUI")  # Dynamic UI for factor variable selection
    ),
    mainPanel(
      tabsetPanel(
        tabPanel("Factor Levels", DTOutput("factorTable")),
        tabPanel("Logistic Regression", plotOutput("coefPlot"))
      )
    )
  )
)

```


