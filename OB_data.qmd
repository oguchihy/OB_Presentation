---
title: "OB DATA Analytics"
author: "Oguchi Nkwocha, MD., MS"
format: html
editor: visual
---

To learn more about Quarto see <https://quarto.org>.

```{r echo=FALSE, message=FALSE, warning=FALSE}
library(quarto)
#source("Ob_dta_reg7.R", local = FALSE)
library(tidyverse)
library(dplyr)
library(dtplyr)
library(lubridate)
library(anytime)
library(janitor)
library(ggplot2)
library(readxl)
library(readr)
library(openxlsx)
library(xlsx)
library(DataExplorer)
library(explore)
library(XICOR)
library(survival)
library(survminer)
library(klaR)
library(ggforestplot)
library(forestplot)
library(myRFunctions)


```

# CSVS OB DATA Analytics

```{r echo = FALSE}
ob_data_compact_qrto <- readRDS("ob_data_compact.RDS")
ob_hghRsk_qrto <- readRDS("High Risk OB.RDS")
dte_range_NMC_data <- range(ob_data_compact_qrto$adm_date)
del_tm_dur_range <- round(range((ob_data_compact_qrto$gest_age_days)/7),1)
age_range <- range(ob_data_compact_qrto$age)
nbr_del_nmc <- nrow(ob_data_compact_qrto)
prcnt_preterm <- round(sum(ob_data_compact_qrto$gest_age_days <259) / sum(ob_data_compact_qrto$gest_age_days >=140)*100,0)
gest_age_range <- range(ob_data_compact_qrto$gest_age_days, na.rm = TRUE)
prcnt_hghRsk <- round(sum(ob_hghRsk_qrto$hghRsk=="yes")/nrow(ob_hghRsk_qrto)*100,0)
```

Between `r dte_range_NMC_data[1]` and `r dte_range_NMC_data[2]`, ***`r nbr_del_nmc`*** CSVS prenatal patients delivered at NMC, which is the principal source of data for this analysis.

The age range was between ***`r age_range[1]`*** and ***`r age_range[2]`***, with a ***median age of `r median(ob_data_compact_qrto$age)`***. (See Histogram below)

```{r echo=FALSE, warning=FALSE}
library(lattice)
histogram(~ age, data = ob_data_compact_qrto, xlab = "Age")
```

Delivery Data at NMC is captured in their OB Delivered Log repository; this includes the following types of information:

```{r echo=FALSE, warning=FALSE}
library(knitr)
column_names <- data.frame(Column_Names = names(ob_data_compact_qrto))
column_names_trimmed <- column_names[1:(nrow(column_names) - 8), ]
kable(column_names_trimmed, caption = "Data Fields")
```

For our analyses, we initially added these derived columns below:

```{r echo=FALSE, warning=FALSE}
derived_cols <- column_names[(nrow(column_names) - 4):nrow(column_names), ]
kable(derived_cols, caption = "Derived Fields")
```


### Definitions

The goal of our data analytics is to understand how various factors affect pregnancy course and delivery in our patient population. We will use NMC data as above. Before we proceed, please be familiar with these definitions:

(@) Event: **Delivery**

There is an associated delivery date and delivery time that defines the event

(@) Intervention: **Admission to the NMC**

A date-time is associated with Intervention

(@) Interval: **Duration** of time between Intervention and Event.

(@) Time: any **slice** of, or **point** , in time (not Duration) within Interval

(@) Survival: **"Survived" Event** at any given Time

This means "survived" delivery, ie., delivery has not occurred at specified Time, or, *undelivered*.

These definitions will facilitate the interpretation of our analyses when we use the popular analytic method called Survival Analysis (SA) or Time to Event (TTE) analysis.

### Cluster Analysis 

Right now, we are going to look into the important OB metrics of Gestational Age and Birth weight of our patients. We will use Cluster Analysis^[Cluster analysis is a statistical technique used to group sets of objects in such a way that objects in the same group are more similar to each other than to those in other groups. It is especially useful in medical research for identifying patterns among patients, aiding in understanding behaviors, disease progression, and treatment outcomes without predefined categories.], a useful method in medical research for identifying patterns among patients that help to characterize clinical states and associated risks and treatment outcomes without predefined categories.

Using k-means clustering algorithm with a choice of 3 clusters (based on clinical relevance), we obtained these stats and plot.

```{r echo=FALSE, warning=FALSE}
#Cluster Analysis----

setwd(getwd())
mdl_clustering_qrto <- ob_data_compact_qrto %>% 
    dplyr::select(age, gest_age_days, weight)

mdl_clustering_qrto_scaled <- scale(mdl_clustering_qrto)


# Cluster Analysis
set.seed(333)

# Perform K-means clustering
k <- 3
kmeans_result_qrto <- kmeans(mdl_clustering_qrto_scaled, centers = k, nstart = 25)

# Add the cluster assignments to the original dataset
ob_data_compact_qrto$cluster <- as.factor(kmeans_result_qrto$cluster)

# Map numeric cluster IDs to meaningful names
cluster_names <- c("Full term", "Early Term",  "Preterm")
names(cluster_names) <- 1:3
ob_data_compact_qrto$cluster <- factor(ob_data_compact_qrto$cluster, levels = 1:3, labels = cluster_names)

# Now, summarizing clusters with across
cluster_summary_qrto <- ob_data_compact_qrto %>%
    group_by(cluster) %>%
    summarise(
        across(
            .cols = c(gest_age_days, weight),
            .fns = ~ round(mean(.), 0),
            .names = "mean {.col}"
        )
    )

kable(cluster_summary_qrto, caption = "Cluster Stats")


# Plotting
library(ggplot2)

ggplot(ob_data_compact_qrto, aes(x = gest_age_days, y = weight, color = cluster)) +
    geom_point(alpha = 0.5) +
    geom_hline(yintercept = 3000, linetype = "dashed", color = "red") +
    geom_vline(xintercept = 259, linetype = "dashed", color = "blue") +
    theme_minimal() +
    scale_x_continuous(
        name = "Gestational Age in completed Weeks",  # Rename the x-axis to "Weeks"
        breaks = seq(0, max(ob_data_compact_qrto$gest_age_days), by = 7),  # Set breaks every 7 days
        labels = function(x) floor(x / 7)  # Convert days to floor weeks
    ) +
    labs(title = "Cluster Analysis on Gestational Age and Birth Weights",
         x = "Gestational Age", y = "Delivery Birthweightin grams")



```

The plot shows the separation of a left lower quad (LLQ) cluster from an unseparated 2 other clusters. Further analysis shows that the LLQ cluster is statistically significantly different from either of the 2 other clusters, while this is not the case between the 2 clusters themselves. By adding the 3000 GRAM birth weight dashed horizontal line and the 37 week dashed vertical line, representing the demarcations for SGA and preterm we find a correspondence between SGA and preterm delivery, a widely known outcome. The clusters were named after this finding: Preterm; Early Term and Full Term from 37 weeks and over. Limitations: preterm deliveries account for only **```r prcnt_preterm```%** of the deliveries; we limited the lower gestational age range to 20 weeks(140 days).